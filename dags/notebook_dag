from airflow import DAG
from airflow.operators.papermill_operator import PapermillOperator
from airflow.providers.trino.operators.trino import TrinoOperator
from datetime import datetime

default_args = {
    'owner': 'airflow',
    'start_date': datetime(2025, 6, 14),
}

with DAG('notebook_dag', default_args=default_args, schedule_interval=None) as dag:
    run_notebook = PapermillOperator(
        task_id='run_demand_analysis',
        input_nb='/opt/airflow/dags/notebooks/demand_analysis.ipynb',
        output_nb='/opt/airflow/logs/demand_analysis_{{ execution_date }}.ipynb',
        parameters={'minio_bucket': 'demand-data'},
    )

    trino_query = TrinoOperator(
        task_id='query_iceberg',
        trino_conn_id='trino_default',
        sql='SELECT * FROM iceberg.demand_table LIMIT 10',
        handler=lambda x: x.fetchall(),
    )

    run_notebook >> trino_query
    